import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤", layout="wide")

st.title("üìâ –ü—Ä–æ–≥–Ω–æ–∑ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤")
st.markdown("–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —É—Ö–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤")

# === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ===
uploaded_file = st.file_uploader("üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤", type=["csv"])

# === –í–∫–ª–∞–¥–∫–∏ ===
tab1, tab2 = st.tabs(["üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç—Ç–æ–∫–∞", "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–¥–µ—Ä–∂–∞–Ω–∏—é"])

# -----------------------------
# üìä –í–ö–õ–ê–î–ö–ê 1 ‚Äî –ê–ù–ê–õ–ò–¢–ò–ö–ê –û–¢–¢–û–ö–ê
# -----------------------------
with tab1:
    if uploaded_file:
        df = pd.read_csv(uploaded_file)

        if "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞" not in df.columns:
            st.error("‚ö†Ô∏è –í —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∞ '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞'")
        else:
            segment = st.selectbox(
                "–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç —Ä–∏—Å–∫–∞", ["–í—Å–µ", "–ù–∞–¥—ë–∂–Ω—ã–π", "–ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–∞", "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"]
            )

            if segment != "–í—Å–µ":
                df = df[df["–°–µ–≥–º–µ–Ω—Ç"] == segment]

            avg_prob = df["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"].mean()
            high_risk = (df["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"] > 0.6).mean() * 100

            col1, col2 = st.columns(2)
            col1.metric("–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞", f"{avg_prob:.2f}")
            col2.metric("–î–æ–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º", f"{high_risk:.1f}%")

            fig, ax = plt.subplots(figsize=(7, 4))
            ax.hist(df["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"], bins=10, color="coral", edgecolor="black")
            ax.set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤")
            ax.set_xlabel("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞")
            ax.set_ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤")
            st.pyplot(fig)

            st.subheader("üîù –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º —É—Ö–æ–¥–∞")
            st.dataframe(
                df.sort_values("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞", ascending=False).head(15),
                use_container_width=True,
            )
    else:
        st.info("üëÜ –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–≤–∫–ª—é—á–∞—è '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞' –∏ '–°–µ–≥–º–µ–Ω—Ç').")

# -----------------------------
# üí° –í–ö–õ–ê–î–ö–ê 2 ‚Äî –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
# -----------------------------
with tab2:
    st.subheader("üí° –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–¥–µ—Ä–∂–∞–Ω–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≤")

    if uploaded_file:
        df = pd.read_csv(uploaded_file)

        if "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞" not in df.columns:
            st.warning("‚ö†Ô∏è –í —Ñ–∞–π–ª–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –æ—Ç—Ç–æ–∫–∞.")
        else:
            def —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏(row):
                if row["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"] > 0.8:
                    return "üìû –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ + –∑–≤–æ–Ω–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
                elif row["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"] > 0.6:
                    return "üíå –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –ø–∏—Å—å–º–æ —Å –±–æ–Ω—É—Å–æ–º"
                elif row["–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞"] > 0.4:
                    return "üéÅ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–∫–∏–¥–∫—É 10% –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑"
                else:
                    return "‚úÖ –ö–ª–∏–µ–Ω—Ç –ª–æ—è–ª–µ–Ω, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é"

            df["–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"] = df.apply(—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, axis=1)

            st.dataframe(
                df[["–°—Ä–µ–¥–Ω–∏–π_—á–µ–∫", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–æ–∫—É–ø–æ–∫", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞", "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"]]
                .sort_values("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_–æ—Ç—Ç–æ–∫–∞", ascending=False)
                .head(15),
                use_container_width=True,
            )
    else:
        st.info("‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏ –æ—Ç—Ç–æ–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.")
